generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum ServiceType {
  HOSTING
  MAINTENANCE
  SEO
  GOOGLE_ADS
  SOCIAL_MEDIA
  WEB_DESIGN
  EMAIL_MARKETING
  CONTENT_WRITING
  BRANDING
  OTHER
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  NEW
  READ
  ARCHIVED
}

// ============================================================
// CLIENT MANAGEMENT
// ============================================================

model Client {
  id                  String          @id @default(uuid())
  name                String
  websiteUrl          String?
  stripeCustomerId    String?         @unique
  umamiSiteId         String?
  umamiShareId        String?
  uptimeKumaMonitorId String?
  searchConsoleUrl    String?
  isActive            Boolean         @default(true)
  notes               String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  services            ClientService[]
  siteChecks          SiteCheck[]
  contacts            ClientContact[]

  @@index([stripeCustomerId])
}

model ClientContact {
  id            String   @id @default(uuid())
  clientId      String
  clerkUserId   String
  email         String
  name          String
  roleLabel     String?
  canDashboard  Boolean  @default(true)
  canBilling    Boolean  @default(true)
  canAnalytics  Boolean  @default(true)
  canUptime     Boolean  @default(true)
  canSupport    Boolean  @default(true)
  canSiteHealth Boolean  @default(true)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, clerkUserId])
  @@index([clerkUserId])
  @@index([email])
  @@index([clientId])
}

model ClientService {
  id        String      @id @default(uuid())
  clientId  String
  type      ServiceType
  label     String?
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  client    Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, type])
  @@index([clientId])
}

// ============================================================
// CACHED SITE CHECKS (PageSpeed + SSL)
// ============================================================

model SiteCheck {
  id                 String    @id @default(uuid())
  clientId           String
  url                String
  performanceScore   Int?
  accessibilityScore Int?
  bestPracticesScore Int?
  seoScore           Int?
  sslValid           Boolean?
  sslIssuer          String?
  sslExpiresAt       DateTime?
  domainRegistrar    String?
  domainExpiresAt    DateTime?
  checkedAt          DateTime  @default(now())

  client             Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([checkedAt])
}

// ============================================================
// KNOWLEDGE BASE
// ============================================================

model KBCategory {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String?
  sortOrder   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  articles    KBArticle[]
}

model KBArticle {
  id          String          @id @default(uuid())
  categoryId  String
  title       String
  slug        String          @unique
  content     String
  excerpt     String?
  status      ArticleStatus   @default(DRAFT)
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  publishedAt DateTime?

  category    KBCategory        @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  feedback    ArticleFeedback[]

  @@index([categoryId])
  @@index([slug])
  @@index([status])
}

model ArticleFeedback {
  id        String    @id @default(uuid())
  articleId String
  helpful   Boolean
  comment   String?
  clientId  String?
  createdAt DateTime  @default(now())

  article   KBArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

// ============================================================
// RECOMMENDED SERVICES (Upsell catalog)
// ============================================================

model RecommendedService {
  id          String      @id @default(uuid())
  type        ServiceType
  title       String
  description String
  features    Json        @default("[]")
  ctaUrl      String?
  ctaLabel    String      @default("Learn More")
  formId      String?
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  form        Form?       @relation(fields: [formId], references: [id], onDelete: SetNull)
}

// ============================================================
// DYNAMIC FORMS
// ============================================================

model Form {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  fields      Json     @default("[]")
  settings    Json     @default("{}")
  isActive    Boolean  @default(true)
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  submissions FormSubmission[]
  services    RecommendedService[]

  @@index([slug])
  @@index([isActive])
}

model FormSubmission {
  id        String           @id @default(uuid())
  formId    String
  data      Json
  metadata  Json             @default("{}")
  status    SubmissionStatus @default(NEW)
  createdAt DateTime         @default(now())

  form      Form             @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([status])
  @@index([createdAt])
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

// ============================================================
// USER TAGS (persistent, WordPress-style)
// ============================================================

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  @@index([name])
}

// ============================================================
// CUSTOM PAGES
// ============================================================

model CustomPage {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String   @default("")
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([isPublished])
}

// ============================================================
// EMAIL CAMPAIGNS
// ============================================================

model EmailCampaign {
  id             String           @id @default(uuid())
  subject        String
  body           String           @db.Text
  sentByUserId   String
  sentByName     String
  sentAt         DateTime         @default(now())
  recipientCount Int
  createdAt      DateTime         @default(now())
  recipients     EmailRecipient[]

  @@index([sentAt])
}

model EmailRecipient {
  id         String        @id @default(uuid())
  campaignId String
  email      String
  name       String
  status     String        @default("sent")
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([email])
}
