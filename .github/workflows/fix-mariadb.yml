name: Move Kuma Proxy to Port 3000

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Switch kuma-proxy to port 3000
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            PROXY_DIR="$HOME/kuma-proxy"

            # Stop old apmuc-portal on port 3000
            pm2 delete apmuc-portal 2>/dev/null || true

            # Update ecosystem to use port 3000
            cat > "$PROXY_DIR/ecosystem.config.js" << 'PM2EOF'
            module.exports = {
              apps: [{
                name: "kuma-proxy",
                script: "server.js",
                cwd: "$HOME/kuma-proxy",
                env: {
                  KUMA_PROXY_PORT: "3000",
                  KUMA_PROXY_API_KEY: "${{ secrets.KUMA_PROXY_API_KEY }}",
                  UPTIME_KUMA_DB_NAME: "db2_uptimekuma_dp7j",
                  UPTIME_KUMA_DB_USER: "u2_uptimekuma_dp7j",
                  UPTIME_KUMA_DB_PASS: "G2prBHnAYJQzahZc"
                }
              }]
            };
            PM2EOF

            # Restart kuma-proxy on port 3000
            cd "$PROXY_DIR"
            pm2 delete kuma-proxy 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save

            echo "=== PM2 status ==="
            pm2 status

            sleep 2

            echo "=== Test health via port 3000 ==="
            curl -s -H "Authorization: Bearer ${{ secrets.KUMA_PROXY_API_KEY }}" http://127.0.0.1:3000/health
            echo ""

            echo "=== Test status via port 3000 ==="
            curl -s -H "Authorization: Bearer ${{ secrets.KUMA_PROXY_API_KEY }}" "http://127.0.0.1:3000/status?monitorId=1"
            echo ""
