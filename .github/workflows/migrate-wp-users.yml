name: Recreate Clerk Users from WordPress

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check WordPress DB on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "=== Try WP database ==="
            mysql -u u1_clientsupport -p'0IKyy6kQBvLbJOe7' db1_clientsupport -e "SELECT user_email, display_name FROM wpno_users;" 2>&1
            echo "=== Done ==="

      - name: Setup SSH tunnel and run migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          # Install sshpass for password-based SSH
          sudo apt-get install -y sshpass

          # Start SSH tunnel: local port 13306 -> VPS localhost:3306
          sshpass -p "$VPS_PASSWORD" ssh -f -N -L 13306:127.0.0.1:3306 \
            -o StrictHostKeyChecking=no \
            "$VPS_USERNAME@$VPS_HOST"

          echo "SSH tunnel established"

          # Install dependencies and generate Prisma client
          npm ci
          npx prisma generate

          # Run the WordPress migration with tunnel
          WP_DB_HOST=127.0.0.1 \
          WP_DB_PORT=13306 \
          WP_DB_USER=u1_clientsupport \
          WP_DB_PASS='0IKyy6kQBvLbJOe7' \
          WP_DB_NAME=db1_clientsupport \
          ADMIN_CLERK_ID=user_3A3QAf11lF9oyoVvBmZOf1e2txD \
          npx tsx scripts/recreate-clerk-users-from-wp.ts
