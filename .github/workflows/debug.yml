name: Debug VPS

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Check VPS logs
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "=== WHOAMI AND HOME ==="
            whoami
            echo $HOME
            echo "=== PM2 INFO ==="
            which pm2
            echo "PM2_HOME=$PM2_HOME"
            ls -la ~/.pm2/ 2>/dev/null | head -20
            echo "=== PORT 3000 (no sudo) ==="
            ss -tln | grep 3000
            echo "=== ALL PROCESSES FOR THIS USER ==="
            ps -u $(whoami) -f
            echo "=== PKILL ALL NODE FOR THIS USER ==="
            pkill -u $(whoami) -f "node" 2>/dev/null || true
            sleep 2
            echo "=== PORT 3000 AFTER PKILL ==="
            ss -tln | grep 3000 || echo "Port 3000 is FREE"
            echo "=== TRY PM2 START ==="
            cd /var/www/new.clientsupport.app
            pm2 start ecosystem.config.js
            sleep 3
            pm2 status
            pm2 logs apmuc-portal --nostream --lines 10
