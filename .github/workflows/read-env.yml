name: Sync VPS Env to Vercel

on: workflow_dispatch

jobs:
  sync-env:
    runs-on: ubuntu-latest
    steps:
      - name: Read env vars from VPS
        id: read-env
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/new.clientsupport.app
            cat .env

      - name: Install Vercel CLI and set env vars
        env:
          VERCEL_TOKEN: placeholder
        run: |
          # We can't easily pipe SSH output to vercel CLI in GHA
          # Instead, output the vars so we can manually set them
          echo "Check the logs for env var values"

      - name: Extract and display env vars
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/new.clientsupport.app
            echo "VARS_START"
            grep -E "^(NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY|CLERK_SECRET_KEY|CLERK_WEBHOOK_SECRET|HELPSCOUT_APP_ID|HELPSCOUT_APP_SECRET|HELPSCOUT_MAILBOX_ID|UMAMI_BASE_URL|UMAMI_API_TOKEN|UPTIME_KUMA_DB_NAME|UPTIME_KUMA_DB_USER|UPTIME_KUMA_DB_PASS|PAGESPEED_API_KEY|CRON_SECRET)=" .env
            echo "VARS_END"
