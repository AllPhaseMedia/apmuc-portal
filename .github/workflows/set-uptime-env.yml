name: Set Uptime Kuma env vars

on:
  workflow_dispatch:

jobs:
  set-env:
    runs-on: ubuntu-latest
    steps:
      - name: Set env vars and monitor ID
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/new.clientsupport.app

            # Remove old Uptime Kuma env vars
            sed -i '/UPTIME_KUMA/d' .env

            # Add Uptime Kuma DB connection vars
            cat >> .env << 'ENVBLOCK'

            # Uptime Kuma (direct DB access - co-located on same server)
            UPTIME_KUMA_DB_HOST="localhost"
            UPTIME_KUMA_DB_PORT="3306"
            UPTIME_KUMA_DB_NAME="db2_uptimekuma_dp7j"
            UPTIME_KUMA_DB_USER="u2_uptimekuma_dp7j"
            UPTIME_KUMA_DB_PASS="G2prBHnAYJQzahZc"
            ENVBLOCK

            echo "Uptime Kuma env vars set:"
            grep UPTIME_KUMA .env

            # Set uptimeKumaMonitorId = 1 on All Phase Media client
            node -e "
              const { PrismaClient } = require('./src/generated/prisma');
              const p = new PrismaClient();
              p.client.updateMany({ where: { name: 'All Phase Media' }, data: { uptimeKumaMonitorId: '1' } })
                .then(r => console.log('Updated', r.count, 'client(s)'))
                .finally(() => p.\$disconnect());
            "
